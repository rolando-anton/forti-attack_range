---
- name: Disable IPv6 on all interfaces
  win_shell: |
    $ipv6adapters = (Get-NetAdapterBinding -DisplayName *IPv6*).Name
    foreach ($ipv6adapters in $ipv6adapters) {
    Disable-NetAdapterBinding -Name $ipv6adapters -ComponentID ms_tcpip6
    }

- name: Convert DHCP IP to Static
  async: 60 
  poll: 10 
  retries: 5
  win_shell: |
    $MgmtIP = "^10\.100\.55."
    $MgmtAdapters = gwmi -cl win32_networkadapterconfiguration -filter "ipenabled = 'true'" | ? {($_.ipaddress -match $MgmtIP) -and $_.dhcpEnabled -eq 'True' }
    $MgmtipAddress = [IPAddress]$MgmtAdapters.IPAddress.Trim()
    $MgmtInterfaceIndex = $MgmtAdapters.InterfaceIndex
    Set-NetIPInterface -InterfaceIndex $MgmtInterfaceIndex -Dhcp Disabled
    New-NetIPAddress -InterfaceIndex "$MgmtInterfaceIndex" -AddressFamily IPv4 -PrefixLength 24 -IPAddress $MgmtipAddress 
    $NonMgmtAdapters = gwmi -cl win32_networkadapterconfiguration -filter "ipenabled = 'true'" | ? {($_.ipaddress -notmatch $MgmtIP) -and $_.dhcpEnabled -eq 'True' }
    foreach ($NonMgmtAdapters in $NonMgmtAdapters) {
    $NonMgmtipAddress = $NonMgmtAdapters.IPAddress
    $NonMgmtsubnetMask = $NonMgmtAdapters.IPSubnet
    $NonMgmtdnsServers = $NonMgmtAdapters.DNSServerSearchOrder
    $NonMgmtdefaultGateway = $NonMgmtAdapters.DefaultIPGateway
    $NonMgmtAdapters.EnableStatic($NonMgmtipAddress,$NonMgmtsubnetMask)
    $NonMgmtAdapters.SetDNSServerSearchOrder($NonMgmtdnsServers)
    $NonMgmtAdapters.SetGateways($NonMgmtdefaultGateway)
    }
 
- name: Change the hostname 
  win_hostname:
    name: "{{ hostname }}"
  register: res

- name: Reboot
  win_reboot:
    connect_timeout: 15
    post_reboot_delay: 15
  when: res.reboot_required
